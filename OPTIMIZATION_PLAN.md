# План оптимизации торгового бота (MOEX Bot)

## 1. Архитектура и Скорость (Execution & Latency)

Текущая проблема: Использование polling (опроса) раз в N секунд создает задержку. Рынок может уйти далеко за 2-3 секунды.

### Рекомендации:
1.  **Переход на gRPC Streams (MarketDataStream):**
    *   Вместо опроса свечей раз в минуту/секунду, подписаться на поток сделок и стакана.
    *   *Цель:* Снижение реакции на изменение цены с 1-2 сек до <50мс.
2.  **Исполнение ордеров (Execution Algo):**
    *   Заменить `Market` ордера на `Limit` ордера (Best Bid/Ask) с логикой перестановки.
    *   Реализовать TWAP (Time-Weighted Average Price) для набора крупных позиций, чтобы не двигать стакан.
    *   *KPI:* Снижение проскальзывания (Slippage) до < 0.05%.

## 2. Торговые Стратегии и ML (AI & Strategy)

Текущая проблема: Модели обучаются, но нет глубокой валидации устойчивости к изменению рыночных режимов.

### Рекомендации:
1.  **Feature Engineering 2.0:**
    *   Добавить микроструктурные данные: дисбаланс стакана (Order Book Imbalance), скорость ленты сделок.
    *   Добавить макро-факторы: корреляция с USDRUB, Oil, S&P500 (через фьючерсы).
2.  **Walk-Forward Optimization:**
    *   Внедрить строгую процедуру бэктеста: обучение на скользящем окне, а не просто Split Train/Test.
3.  **Ансамблирование:**
    *   Использовать VotingClassifier (XGBoost + CatBoost + LightGBM) для повышения робастности.
    *   *KPI:* Profit Factor > 1.6, Sharpe Ratio > 2.0.

## 3. Риск-менеджмент (Risk & Money Management)

Текущая проблема: Фиксированные стопы и проценты.

### Рекомендации:
1.  **Динамический сайзинг (Position Sizing):**
    *   Расчет объема позиции на основе текущей волатильности (ATR) инструмента. Чем выше волатильность, тем меньше лот.
2.  **Контроль корреляций:**
    *   Если открыт Long по SBER и Long по GAZP (высокая корреляция), риск на портфель удваивается. Бот должен учитывать "риск на сектор".
3.  **Circuit Breaker (Предохранитель):**
    *   Полная остановка торговли на сегодня, если просадка превысила X% (например, 3%).
    *   *KPI:* Max Drawdown < 10% за месяц.

## 4. Инфраструктура и Логирование

Текущая проблема: CSV файлы, сложность анализа логов.

### Рекомендации:
1.  **База данных:**
    *   Миграция с CSV на SQLite (для локальной версии) или PostgreSQL + TimescaleDB (для сервера). Это ускорит выборку данных для обучения в разы.
2.  **Мониторинг:**
    *   Внедрить Grafana + Prometheus (или упрощенный дашборд в Telegram) для отображения:
        *   Задержки API (Ping).
        *   Количества ошибок API в минуту.
        *   Экспозиции (общей загрузки депозита).

## Дорожная карта (Roadmap)

### Этап 1: Фундамент (1 неделя)
- [ ] Внедрить базу данных SQLite вместо CSV.
- [ ] Реализовать Circuit Breaker (дневной лимит потерь).

### Этап 2: Скорость (1-2 недели)
- [ ] Переписать `DataCollector` на использование gRPC Streams.
- [ ] Реализовать лимитные ордера с перестановкой.

### Этап 3: Интеллект (2-3 недели)
- [ ] Добавить данные стакана в фичи для ML.
- [ ] Реализовать Walk-Forward валидацию.
