"""
Справочник коэффициентов маржи для фьючерсов MOEX.
ОСНОВНОЙ ИСТОЧНИК - значения из терминала Tinkoff.

ВАЖНО: API возвращает dlong/dshort, но эти значения НЕ соответствуют реальной марже!
Например, для NGG6:
- API dlong = 0.33 руб
- Терминал: гарантийное обеспечение = 7 667,72 ₽ за лот

Поэтому используем этот словарь как ОСНОВНОЙ источник маржи.
Значения обновляются вручную из терминала Tinkoff.
"""
from typing import Dict, Optional

# Справочник гарантийного обеспечения за лот для каждого инструмента (ОСНОВНОЙ ИСТОЧНИК)
# Значения в рублях за 1 лот
# ВАЖНО: Это ОСНОВНОЙ источник маржи! API значения (dlong/dshort) НЕВЕРНЫЕ!
# Значения обновляются вручную из терминала Tinkoff
MARGIN_PER_LOT: Dict[str, float] = {
    # Фьючерсы на серебро
    "S1H6": 0.28,  # SILVM-3.26 Серебро (мини) - из терминала
    "SVH6": 0.28,  # TODO: обновить из терминала
    # Фьючерсы на газ
    "NRG6": 0.27,  # NGM-2.26 Природный газ (микро) - значительно увеличен для учета реальных требований биржи
    # Фьючерсы на платину
    "PTH6": 33860.23,  # PLT-3.26 Платина - из терминала (гарантийное обеспечение за лот)
    # Фьючерсы на газ природный
    "NGG6": 7667.72,  # NG-2.26 Природный газ - из терминала (гарантийное обеспечение за лот)
    # Другие инструменты
    "VBH6": 0.0,  # TODO: обновить из терминала
    "SRH6": 0.0,  # TODO: обновить из терминала
    "GLDRUBF": 0.0,  # TODO: обновить из терминала
}

# Коэффициенты маржи в процентах от стоимости позиции (fallback)
# Используются, если нет данных в MARGIN_PER_LOT
# Значения из optimal_instruments CSV файла
MARGIN_RATE_PCT: Dict[str, float] = {
    "S1H6": 20.2,  # ~1558.96 / (77.19 * 1) * 100 (из терминала)
    "SVH6": 15.0,  # ~11.7 / 78.0 * 100 (из CSV)
    "NRG6": 50.0,  # Увеличен до 50% для учета реальных требований биржи (было 15%)
    "PTH6": 15.0,  # ~306.75 / 2045.0 * 100 (из CSV)
    "NGG6": 50.0,  # Увеличен до 50% для учета реальных требований биржи (было 15%)
    "VBH6": 12.0,  # По умолчанию
    "SRH6": 12.0,  # По умолчанию
    "GLDRUBF": 12.0,  # По умолчанию
}


# Справочник стоимости пункта цены для инструментов (из терминала)
# Используется для расчета маржи по формуле: ГО = стоимость_пункта * цена * dlong/dshort
POINT_VALUE: Dict[str, float] = {
    "PTH6": 77.19,  # PLT-3.26 Платина - из терминала
    # TODO: добавить для других инструментов
}

def get_margin_for_position(
    ticker: str, 
    quantity: float, 
    entry_price: float, 
    lot_size: float = 1.0,
    dlong: Optional[float] = None,
    dshort: Optional[float] = None,
    is_long: bool = True
) -> float:
    """
    Получить гарантийное обеспечение для позиции.
    
    Приоритет расчета:
    1. Справочник MARGIN_PER_LOT (если есть значение)
    2. Расчет через стоимость пункта: ГО = стоимость_пункта * цена * dlong/dshort
    3. Процент от стоимости позиции (fallback)
    
    Args:
        ticker: Тикер инструмента
        quantity: Количество лотов
        entry_price: Цена входа
        lot_size: Размер лота
        dlong: Коэффициент dlong из API (опционально)
        dshort: Коэффициент dshort из API (опционально)
        is_long: True для LONG позиции, False для SHORT
        
    Returns:
        Гарантийное обеспечение в рублях
    """
    ticker_upper = ticker.upper()
    
    # 1. Сначала пробуем использовать справочник гарантийного обеспечения за лот
    if ticker_upper in MARGIN_PER_LOT and MARGIN_PER_LOT[ticker_upper] > 0:
        margin_per_lot = MARGIN_PER_LOT[ticker_upper]
        return margin_per_lot * quantity
    
    # 2. Пробуем расчет через стоимость пункта цены (если известны dlong/dshort и стоимость пункта)
    if ticker_upper in POINT_VALUE and entry_price > 0:
        point_value = POINT_VALUE[ticker_upper]
        
        # Используем dlong для LONG, dshort для SHORT
        if is_long and dlong is not None and dlong > 0:
            margin_per_lot = point_value * entry_price * dlong
            return margin_per_lot * quantity
        elif not is_long and dshort is not None and dshort > 0:
            margin_per_lot = point_value * entry_price * dshort
            return margin_per_lot * quantity
    
    # 3. Fallback: используем процент от стоимости позиции
    if ticker_upper in MARGIN_RATE_PCT:
        margin_rate = MARGIN_RATE_PCT[ticker_upper] / 100.0
    else:
        margin_rate = 0.12  # 12% по умолчанию
    
    position_value = entry_price * quantity * lot_size
    return position_value * margin_rate


def update_margin_per_lot(ticker: str, margin_per_lot: float):
    """
    Обновить гарантийное обеспечение за лот для инструмента.
    
    Args:
        ticker: Тикер инструмента
        margin_per_lot: Гарантийное обеспечение за лот в рублях
    """
    ticker_upper = ticker.upper()
    MARGIN_PER_LOT[ticker_upper] = margin_per_lot
    
    # Автоматически обновляем процентный коэффициент, если известна цена
    # (это можно сделать позже, когда будет известна текущая цена)
