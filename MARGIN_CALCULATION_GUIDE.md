# Руководство по расчету гарантийного обеспечения (ГО)

## Проблема

API Tinkoff возвращает значения `dlong`/`dshort`, которые **НЕ соответствуют реальной марже**:
- Для NGG6: API dlong = 0.33 руб, но реальная маржа = 7 667,72 ₽
- Для PTH6: API dlong = 0.2834 руб, но реальная маржа = 33 860,23 ₽

## Найденные формулы

### Для PTH6 (с известной стоимостью пункта)

**Формула для SHORT позиции:**
```
ГО = стоимость_пункта * цена * dshort
ГО = 77.19 * 2049.7 * 0.214 = 33 860,23 ₽ ✅
```

**Формула для LONG позиции:**
```
ГО = стоимость_пункта * цена * dlong
ГО = 77.19 * 2049.7 * 0.2834 = 44 860,23 ₽
```

### Для NGG6

Формула не найдена через API. Значение из терминала: **7 667,72 ₽ за лот**

## Текущее решение

1. **Словарь `MARGIN_PER_LOT`** - основной источник маржи
   - Значения обновляются вручную из терминала Tinkoff
   - Используется как приоритетный источник

2. **Расчет через стоимость пункта** (для инструментов с известной стоимостью пункта)
   - Формула: `ГО = стоимость_пункта * цена * dlong/dshort`
   - Требует добавления стоимости пункта в словарь `POINT_VALUE`

3. **Fallback** - процент от стоимости позиции
   - Используется только если нет данных в словаре

## Как обновить значения маржи

1. Откройте терминал Tinkoff
2. Найдите инструмент
3. Посмотрите "Гарантийное обеспечение" (за лот)
4. Обновите значение в `bot/margin_rates.py`:

```python
MARGIN_PER_LOT: Dict[str, float] = {
    "PTH6": 33860.23,  # Из терминала
    "NGG6": 7667.72,   # Из терминала
    # ...
}
```

## Автоматическая проверка

Используйте скрипт для проверки всех активных инструментов:

```bash
python check_margins.py
```

Скрипт покажет:
- Значения из API (dlong/dshort)
- Значения из словаря
- Различия
- Рекомендации по обновлению

## Проблема с балансом

Если баланс меньше гарантийного обеспечения, нельзя открыть даже 1 лот:
- NGG6: нужно минимум **7 667,72 ₽**
- PTH6: нужно минимум **33 860,23 ₽**

Это причина ошибки "Not enough assets for a margin trade".

## Рекомендации

1. ✅ **Используйте словарь** как основной источник маржи
2. ✅ **Регулярно обновляйте** значения из терминала
3. ✅ **Проверяйте баланс** перед открытием позиции
4. ⚠️ **Не полагайтесь на API** значения dlong/dshort - они неверные

## Будущие улучшения

- [ ] Найти способ получения стоимости пункта через API
- [ ] Автоматическое обновление словаря из терминала
- [ ] Получение margin requirements через другой метод API
