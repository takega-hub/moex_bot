# Критерии отбора инструментов в find_optimal_instruments.py

## Обзор

Скрипт `find_optimal_instruments.py` использует многоуровневую систему фильтрации инструментов. Все критерии применяются последовательно, начиная с самых быстрых проверок.

---

## Уровень 1: Получение списка фьючерсов (`get_all_futures`)

### Критерий 1.1: Доступность через API

```python
if not getattr(instrument, 'api_trade_available_flag', False):
    continue  # Пропускаем
```

**Условие:** Инструмент должен быть доступен для торговли через API.

**Параметры:** Нет (зависит от API)

---

### Критерий 1.2: Тип инструмента

```python
is_metal = is_metal_future(instrument)  # Металлы
is_stock = is_stock_future(instrument)  # Акции

if (filter_metals and is_metal) or (filter_stocks and is_stock):
    # Включаем в список
```

**Условие:** Инструмент должен быть фьючерсом на металл ИЛИ на акцию.

**Параметры:**
- `--filter-metals` / `--no-metals` (по умолчанию: включены)
- `--filter-stocks` / `--no-stocks` (по умолчанию: включены)

**Определение типа:**
- **Металлы:** По ключевым словам в названии/тикере (серебро, золото, платина, палладий, медь, алюминий)
- **Акции:** По `asset_type == 'share'` или тикерам акций (SBER, GAZP, LKOH и т.д.)

---

## Уровень 2: Анализ инструмента (`analyze_instrument`)

### Критерий 2.1: Доступность текущей цены

```python
if current_price is None or current_price <= 0:
    return None  # Пропускаем
```

**Условие:** Должна быть доступна текущая цена инструмента.

**Проверка:** Пробует получить цену из свечей (1min → 5min → 15min → 1hour)

**Параметры:** Нет (зависит от API)

---

### Критерий 2.2: ГО и баланс (В ПЕРВУЮ ОЧЕРЕДЬ)

#### Проверка 2.2.1: Достаточность баланса для 1 лота

```python
if margin_per_lot > balance:
    return None  # Пропускаем
```

**Условие:** ГО за лот не должно превышать доступный баланс.

**Формула:** `ГО = min_price_increment × current_price × dshort/dlong`

**Параметры:**
- `--balance` (по умолчанию: 5000.0 ₽)

**Пример:**
- Баланс: 5000 ₽
- ГО: 15751.12 ₽ → ❌ Пропускаем (недостаточно для 1 лота)

---

#### Проверка 2.2.2: Максимальный процент ГО от баланса

```python
max_margin = balance * (margin_pct / 100.0)
if margin_per_lot > max_margin:
    return None  # Пропускаем
```

**Условие:** ГО не должно превышать максимальный процент от баланса.

**Параметры:**
- `--margin-pct` (по умолчанию: 25.0%)

**Пример:**
- Баланс: 5000 ₽
- `margin_pct`: 25%
- `max_margin`: 5000 × 0.25 = 1250 ₽
- ГО: 1500 ₽ → ❌ Пропускаем (превышает 25% от баланса)

---

### Критерий 2.3: Достаточность исторических данных

```python
if not candles or len(candles) < 10:
    return None  # Пропускаем
```

**Условие:** Должно быть минимум 10 свечей за период анализа.

**Параметры:**
- `--period-days` (по умолчанию: 30 дней)

**Примечание:** Проверка происходит **после** фильтрации по ГО, чтобы не тратить время на сбор данных для неподходящих инструментов.

---

### Критерий 2.4: Волатильность

```python
if volatility < volatility_min or volatility > volatility_max:
    return None  # Пропускаем
```

**Условие:** Дневная волатильность должна быть в заданном диапазоне.

**Расчет волатильности:**
- Метод: ATR (Average True Range)
- Период: 14 дней (или все доступные данные, если меньше)
- Формула: `volatility_pct = (ATR / current_price) × 100`

**Параметры:**
- `--volatility-min` (по умолчанию: 1.0%)
- `--volatility-max` (по умолчанию: 5.0%)

**Пример:**
- `volatility_min`: 1.0%
- `volatility_max`: 5.0%
- Рассчитанная волатильность: 0.5% → ❌ Пропускаем (слишком низкая)
- Рассчитанная волатильность: 6.0% → ❌ Пропускаем (слишком высокая)
- Рассчитанная волатильность: 2.5% → ✅ Проходит

---

## Уровень 3: Ранжирование (`filter_and_rank_instruments`)

### Критерий 3.1: Расчет score (оценки)

```python
volatility_mid = (volatility_min + volatility_max) / 2
volatility_score = 1.0 - abs(volatility - volatility_mid) / volatility_mid
volume_score = min(avg_volume_rub / 1000000.0, 1.0)  # Нормализация к 1M RUB
score = (volume_score * 0.7 + volatility_score * 0.3) * 100
```

**Формула:**
- `volatility_score`: Близость волатильности к середине диапазона (0-1)
- `volume_score`: Объем в RUB, нормализованный к 1M RUB (0-1)
- `score`: Взвешенная сумма (70% объем, 30% волатильность) × 100

**Приоритет:**
1. Объем (70%) - выше объем = выше score
2. Волатильность (30%) - ближе к середине диапазона = выше score

---

### Критерий 3.2: Сортировка результатов

```python
sorted_results = sorted(
    results,
    key=lambda x: (
        -x.get("score", 0),           # Выше score = выше приоритет
        -x.get("avg_volume_rub", 0),   # Выше объем = выше приоритет
        x.get("margin_per_lot", float('inf'))  # Ниже маржа = выше приоритет
    )
)
```

**Приоритет сортировки:**
1. **Score** (по убыванию) - главный критерий
2. **Объем в RUB** (по убыванию) - при равном score
3. **ГО за лот** (по возрастанию) - при равном score и объеме

---

### Критерий 3.3: Ограничение количества результатов

```python
return sorted_results[:limit]
```

**Условие:** Возвращается только топ-N результатов.

**Параметры:**
- `--limit` (по умолчанию: 50)

---

## Сводная таблица критериев

| Уровень | Критерий | Параметр | По умолчанию | Приоритет |
|---------|----------|----------|--------------|-----------|
| 1.1 | API доступность | - | - | Высокий |
| 1.2 | Тип инструмента | `--filter-metals`, `--filter-stocks` | Оба включены | Высокий |
| 2.1 | Текущая цена | - | - | Высокий |
| 2.2.1 | ГО <= баланс | `--balance` | 5000 ₽ | **КРИТИЧЕСКИЙ** |
| 2.2.2 | ГО <= % от баланса | `--margin-pct` | 25% | **КРИТИЧЕСКИЙ** |
| 2.3 | Исторические данные | `--period-days` | 30 дней | Средний |
| 2.4 | Волатильность | `--volatility-min`, `--volatility-max` | 1-5% | Средний |
| 3.1 | Score (оценка) | - | - | Низкий (ранжирование) |
| 3.2 | Сортировка | - | - | Низкий (ранжирование) |
| 3.3 | Лимит результатов | `--limit` | 50 | Низкий (ранжирование) |

---

## Порядок применения критериев

```
1. Получение списка фьючерсов
   ├─ 1.1 API доступность
   └─ 1.2 Тип инструмента (металлы/акции)

2. Анализ каждого инструмента
   ├─ 2.1 Текущая цена
   ├─ 2.2 ГО и баланс ⚡ (В ПЕРВУЮ ОЧЕРЕДЬ)
   │   ├─ 2.2.1 ГО <= баланс
   │   └─ 2.2.2 ГО <= % от баланса
   ├─ 2.3 Исторические данные (только если прошли 2.2)
   └─ 2.4 Волатильность (только если прошли 2.3)

3. Ранжирование результатов
   ├─ 3.1 Расчет score
   ├─ 3.2 Сортировка
   └─ 3.3 Ограничение количества
```

---

## Примеры использования

### Пример 1: Только металлы, баланс 10000 ₽

```bash
python find_optimal_instruments.py \
    --balance 10000 \
    --no-stocks \
    --margin-pct 20 \
    --volatility-min 1.5 \
    --volatility-max 4.0
```

**Критерии:**
- ✅ Только металлы
- ✅ Баланс: 10000 ₽
- ✅ ГО <= 20% от баланса (2000 ₽)
- ✅ Волатильность: 1.5-4.0%

---

### Пример 2: Только акции, низкая волатильность

```bash
python find_optimal_instruments.py \
    --balance 5000 \
    --no-metals \
    --volatility-min 0.5 \
    --volatility-max 2.0 \
    --limit 20
```

**Критерии:**
- ✅ Только акции
- ✅ Баланс: 5000 ₽
- ✅ ГО <= 25% от баланса (1250 ₽)
- ✅ Волатильность: 0.5-2.0%
- ✅ Топ-20 результатов

---

## Рекомендации по настройке

1. **Баланс (`--balance`):**
   - Укажите реальный баланс счета
   - Или используйте `--balance` без значения для получения из API

2. **Процент ГО (`--margin-pct`):**
   - 15-20%: Консервативный подход (больше диверсификации)
   - 25-30%: Умеренный подход (баланс между диверсификацией и размером позиций)
   - 40-50%: Агрессивный подход (крупные позиции, меньше инструментов)

3. **Волатильность (`--volatility-min`, `--volatility-max`):**
   - 0.5-2.0%: Низкая волатильность (стабильные инструменты)
   - 1.0-5.0%: Средняя волатильность (баланс)
   - 3.0-10.0%: Высокая волатильность (высокий риск/доходность)

4. **Период анализа (`--period-days`):**
   - 7-14 дней: Краткосрочный анализ
   - 30 дней: Среднесрочный анализ (рекомендуется)
   - 60-90 дней: Долгосрочный анализ

---

## Логирование

### Успешные проверки:
```
✅ TBH6: Фильтр по ГО/балансу ПРОЙДЕН - ГО 885.75 ₽ (17.7% от баланса), максимум лотов: 5
```

### Неуспешные проверки:
```
❌ SVH6: Фильтр по ГО/балансу НЕ ПРОЙДЕН - ГО 15751.12 ₽ > баланс 5000.00 ₽
❌ PTH6: Фильтр по ГО/балансу НЕ ПРОЙДЕН - ГО 33860.23 ₽ > максимальная маржа 1250.00 ₽ (25% от баланса)
Skipping S1H6: volatility 0.8% not in range [1.0, 5.0]
```

---

## Вывод

Скрипт использует **многоуровневую систему фильтрации** с приоритетом на **ГО и баланс** (критерии 2.2.1 и 2.2.2), которые проверяются **в первую очередь** до сбора исторических данных. Это оптимизирует производительность и экономит время на неподходящих инструментах.
