# Реальный расчет ГО для TBH6 (из терминала)

## Данные из терминала Tinkoff

**Инструмент:** T-3.26 Т-Технологии (TBH6)

**Параметры:**
- Текущая цена: **3 531 пт.** (пункты)
- Гарантийное обеспечение: **885,75 ₽** за лот
- Примерная стоимость: **3 543,00 ₽**

---

## Анализ расчета

### Что показал скрипт

```python
# Данные из API:
current_price = 3531.00 ₽
min_price_increment = 1.0
dlong = 0.25
dshort = 0.25

# Расчет через формулу:
margin = min_price_increment × current_price × dshort
margin = 1.0 × 3531.0 × 0.25 = 882.75 ₽
```

**Ожидаемый результат:** 882.75 ₽ (почти совпадает с терминалом 885.75 ₽)

**Фактический результат скрипта:** 423.72 ₽

---

## Почему расхождение?

### Проблема: используется fallback вместо формулы

Скрипт рассчитал **423.72 ₽**, что равно:
```
3531.0 × 0.12 = 423.72 ₽
```

Это означает, что **использовался fallback (12% от стоимости лота)**, а не формула через `min_price_increment`.

### Почему формула не сработала?

Вероятно, функция `get_margin_per_lot_from_api_data` вернула `None`, и код перешел к `get_margin_for_position`, которая использовала fallback.

**Правильный расчет через формулу должен быть:**
```
ГО = min_price_increment × current_price × dshort
ГО = 1.0 × 3531.0 × 0.25 = 882.75 ₽
```

Это **почти совпадает** с терминалом (885.75 ₽) - разница всего 3 ₽ (0.34%).

### Возможные причины:

1. **Функция `get_margin_per_lot_from_api_data` вернула None**
   - Возможно, `min_price_increment` не был передан правильно
   - Или проверка `point_value > 0` не прошла

2. **Использовалась функция `get_margin_for_position` с fallback**
   - Если `min_price_increment` не был использован, функция перешла к fallback

---

## Правильный расчет

### Формула из терминала

```
ГО = 885.75 ₽ за лот
```

### Расчет через формулу (если бы работала)

```
ГО = min_price_increment × current_price × dshort
ГО = 1.0 × 3531.0 × 0.25 = 882.75 ₽
```

**Разница с терминалом:** 885.75 - 882.75 = 3.0 ₽ (0.34%)

Это нормально, так как:
- Цена может немного измениться
- Могут быть округления
- Терминал показывает актуальное значение на момент открытия

---

## Решение: добавить в словарь

### Обновление `bot/margin_rates.py`

```python
MARGIN_PER_LOT = {
    # ...
    "TBH6": 885.75,  # T-3.26 Т-Технологии - из терминала
}
```

### После обновления

```python
# Приоритет 1: Проверка словаря
if "TBH6" in MARGIN_PER_LOT and MARGIN_PER_LOT["TBH6"] > 0:
    margin_per_lot = MARGIN_PER_LOT["TBH6"]  # 885.75 ₽
    # ✅ ИСПОЛЬЗУЕМ ЭТО ЗНАЧЕНИЕ (самое точное!)
```

---

## Проверка баланса для TBH6

### С реальным ГО из терминала

```python
balance = 5000.0 ₽
margin_per_lot = 885.75 ₽  # Из терминала

# Проверка 1: Достаточно ли для 1 лота?
if 885.75 <= 5000.0:  # ✅ Да
    max_lots = 5000.0 / 885.75 = 5 лот(ов)

# Проверка 2: Не превышает ли 25% от баланса?
max_margin = 5000.0 × 0.25 = 1250.0 ₽
if 885.75 <= 1250.0:  # ✅ Да
    # Инструмент подходит!
```

---

## Сравнение методов расчета

| Метод | Результат | Точность | Статус |
|-------|-----------|----------|--------|
| **Терминал Tinkoff** | 885.75 ₽ | ✅ 100% | Источник истины |
| Формула (min_price_increment) | 882.75 ₽ | ✅ 99.66% | Почти точно |
| Fallback (12%) | 423.72 ₽ | ❌ 47.8% | Неверно |

**Вывод:** Нужно использовать значение из терминала (885.75 ₽) или формулу, если она работает.

---

## Рекомендации

1. ✅ **Добавить TBH6 в словарь** с значением 885.75 ₽
2. ✅ **Проверить логику** использования `min_price_increment` в скрипте
3. ⚠️ **Проверить**, почему формула не сработала (возможно, `min_price_increment` не был передан)

---

## Обновленный расчет после добавления в словарь

```python
# После обновления bot/margin_rates.py:
MARGIN_PER_LOT["TBH6"] = 885.75

# При расчете:
margin_per_lot = MARGIN_PER_LOT["TBH6"]  # 885.75 ₽ ✅

# Проверка баланса:
balance = 5000.0 ₽
if 885.75 <= 5000.0:  # ✅
    max_lots = 5 лот(ов)
```

**Результат:** ✅ Инструмент подходит для торговли с балансом 5000 ₽
