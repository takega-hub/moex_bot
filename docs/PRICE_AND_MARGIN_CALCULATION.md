# –†–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –∏ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è (–ì–û)

## –û–±–∑–æ—Ä

–°–∫—Ä–∏–ø—Ç `find_optimal_instruments.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:
1. **–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞** - –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ª–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
2. **–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (–ì–û)** - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∞

---

## 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã

```python
def get_current_price(client, figi):
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (–æ—Ç —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö –∫ –º–µ–Ω–µ–µ —Å–≤–µ–∂–∏–º):
    1. 1min —Å–≤–µ—á–∏ (—Å–∞–º—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
    2. 5min —Å–≤–µ—á–∏
    3. 15min —Å–≤–µ—á–∏
    4. 1hour —Å–≤–µ—á–∏ (fallback)
    
    # –ü–µ—Ä–∏–æ–¥ –∑–∞–ø—Ä–æ—Å–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–ü–µ—Ä–∏–æ–¥ –∑–∞–ø—Ä–æ—Å–∞**: 2 —á–∞—Å–∞ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 1-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏ –¥–∞—é—Ç —Å–∞–º—É—é –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
- **Fallback**: –ï—Å–ª–∏ 1min –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

### –ü—Ä–∏–º–µ—Ä

```python
# –î–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å FIGI "FUTSILV03260"
# 1. –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å 1min —Å–≤–µ—á–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
# 2. –ï—Å–ª–∏ –µ—Å—Ç—å - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É, —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è = 78.0 ‚ÇΩ
# 3. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–±—É–µ–º 5min, –∑–∞—Ç–µ–º 15min, –∑–∞—Ç–µ–º 1hour
```

---

## 2. –†–∞—Å—á–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è (–ì–û)

### –í–∞–∂–Ω–æ: –ì–û vs –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞

**–î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤:**
- ‚úÖ **–ì–û –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ** - —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
- ‚ùå **–°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è** - —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ä–∞—Å—á–µ—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: SILV-3.26 (—Å–µ—Ä–µ–±—Ä–æ)
- –¶–µ–Ω–∞: 78.0 ‚ÇΩ
- –õ–æ—Ç–Ω–æ—Å—Ç—å: 10
- –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞: 78.0 √ó 10 = 780 ‚ÇΩ (–ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
- –ì–û: 15 751.12 ‚ÇΩ (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ)

**–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è 1 –ª–æ—Ç–∞ –Ω—É–∂–Ω–æ:**
- ‚úÖ –ì–û: 15 751.12 ‚ÇΩ (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
- ‚ùå –ù–ï –Ω—É–∂–Ω–æ: 780 ‚ÇΩ (—Å—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞)

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ –ì–û (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ MARGIN_PER_LOT

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ bot/margin_rates.py?
if ticker in MARGIN_PER_LOT and MARGIN_PER_LOT[ticker] > 0:
    margin_per_lot = MARGIN_PER_LOT[ticker]  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    return margin_per_lot
```

**–ò—Å—Ç–æ—á–Ω–∏–∫**: –¢–µ—Ä–º–∏–Ω–∞–ª Tinkoff (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é)

**–ü—Ä–∏–º–µ—Ä—ã:**
- `S1H6`: 1574.5 ‚ÇΩ
- `SVH6`: 15751.12 ‚ÇΩ
- `NGG6`: 7667.72 ‚ÇΩ
- `PTH6`: 33860.23 ‚ÇΩ

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```python
# –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–ª–æ–≤–∞—Ä–µ –Ω–µ—Ç, –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
# –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è S1H7 (–Ω–æ–≤—ã–π) –Ω–∞—Ö–æ–¥–∏–º S1H6 (–∏–∑–≤–µ—Å—Ç–Ω—ã–π)
known_margin = MARGIN_PER_LOT["S1H6"]  # 1574.5 ‚ÇΩ
current_price = 78.0
dshort = 0.214  # –ò–∑ API

# –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–∞
point_value = known_margin / (current_price * dshort)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä–∂–∏ –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
margin = point_value * current_price * dshort
```

**–ì—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:**
- –°–µ—Ä–µ–±—Ä–æ: `S1H6`, `SVH6` ‚Üí –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–µ–±—Ä–æ
- –ü–ª–∞—Ç–∏–Ω–∞: `PTH6` ‚Üí –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç–∏–Ω—É
- –ì–∞–∑: `NGG6`, `NRG6` ‚Üí –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –≥–∞–∑

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–∞

```python
# –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ POINT_VALUE
if ticker in POINT_VALUE:
    point_value = POINT_VALUE[ticker]
    margin = point_value * current_price * dlong/dshort
```

**–§–æ—Ä–º—É–ª–∞:**
```
–ì–û = —Å—Ç–æ–∏–º–æ—Å—Ç—å_–ø—É–Ω–∫—Ç–∞ √ó —Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞ √ó dlong (–¥–ª—è LONG)
–ì–û = —Å—Ç–æ–∏–º–æ—Å—Ç—å_–ø—É–Ω–∫—Ç–∞ √ó —Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞ √ó dshort (–¥–ª—è SHORT)
```

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: Fallback (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏)

```python
# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
margin_rate = MARGIN_RATE_PCT.get(ticker, 0.12)  # 12% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
margin = lot_value * margin_rate
```

**–ü—Ä–∏–º–µ—Ä:**
- `lot_value = 780 ‚ÇΩ` (—Ü–µ–Ω–∞ √ó –ª–æ—Ç–Ω–æ—Å—Ç—å)
- `margin_rate = 0.15` (15%)
- `margin = 780 √ó 0.15 = 117 ‚ÇΩ`

---

## 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∞

### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

```python
# –í–ê–ñ–ù–û: –î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ì–û
# –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ì–û –¥–ª—è 1 –ª–æ—Ç–∞?
if margin_per_lot > balance:
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    return None

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ì–û –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –±–∞–ª–∞–Ω—Å–∞?
max_margin = balance * (margin_pct / 100.0)  # –ù–∞–ø—Ä–∏–º–µ—Ä, 25% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
if margin_per_lot > max_margin:
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    return None
```

### –†–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–æ—Ç–æ–≤

```python
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–æ—Ç–∞ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ì–û
max_lots = int(balance / margin_per_lot)
```

**–ü—Ä–∏–º–µ—Ä:**
- –ë–∞–ª–∞–Ω—Å: 5000 ‚ÇΩ
- –ì–û –∑–∞ –ª–æ—Ç: 1574.5 ‚ÇΩ
- –ú–∞–∫—Å–∏–º—É–º –ª–æ—Ç–æ–≤: `5000 / 1574.5 = 3` –ª–æ—Ç–∞

---

## 4. –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞

### –ü—Ä–∏–º–µ—Ä 1: S1H6 (–°–µ—Ä–µ–±—Ä–æ –º–∏–Ω–∏)

```python
# –î–∞–Ω–Ω—ã–µ –∏–∑ API:
current_price = 78.0 ‚ÇΩ
lot_size = 1
dlong = 0.214
dshort = 0.214

# –†–∞—Å—á–µ—Ç:
lot_value = 78.0 √ó 1 = 78.0 ‚ÇΩ  # –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

# –ì–û (–∏–∑ —Å–ª–æ–≤–∞—Ä—è):
margin_per_lot = 1574.5 ‚ÇΩ  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
if margin_per_lot <= balance:  # 1574.5 <= 5000 ‚úÖ
    max_lots = 5000 / 1574.5 = 3 –ª–æ—Ç–∞
```

### –ü—Ä–∏–º–µ—Ä 2: SVH6 (–°–µ—Ä–µ–±—Ä–æ, –ª–æ—Ç–Ω–æ—Å—Ç—å=10)

```python
# –î–∞–Ω–Ω—ã–µ –∏–∑ API:
current_price = 78.0 ‚ÇΩ
lot_size = 10
dlong = 0.214
dshort = 0.214

# –†–∞—Å—á–µ—Ç:
lot_value = 78.0 √ó 10 = 780 ‚ÇΩ  # –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

# –ì–û (–∏–∑ —Å–ª–æ–≤–∞—Ä—è):
margin_per_lot = 15751.12 ‚ÇΩ  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
if margin_per_lot <= balance:  # 15751.12 <= 5000 ‚ùå
    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞)
```

### –ü—Ä–∏–º–µ—Ä 3: NGG6 (–ì–∞–∑)

```python
# –î–∞–Ω–Ω—ã–µ –∏–∑ API:
current_price = 3.22 ‚ÇΩ
lot_size = 1
dlong = 0.33  # –ò–∑ API (–ù–ï–í–ï–†–ù–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ!)
dshort = 0.33

# –†–∞—Å—á–µ—Ç:
lot_value = 3.22 √ó 1 = 3.22 ‚ÇΩ  # –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

# –ì–û (–∏–∑ —Å–ª–æ–≤–∞—Ä—è, —Ç.–∫. API dlong –ù–ï–í–ï–†–ù–´–ô):
margin_per_lot = 7667.72 ‚ÇΩ  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—á–µ—Ç–µ

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
if margin_per_lot <= balance:  # 7667.72 <= 5000 ‚ùå
    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞)
```

---

## 5. –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### ‚ö†Ô∏è API –∑–Ω–∞—á–µ–Ω–∏—è dlong/dshort –ù–ï–í–ï–†–ù–´–ï!

**–ü—Ä–æ–±–ª–µ–º–∞:**
- API Tinkoff –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `dlong`/`dshort`, –∫–æ—Ç–æ—Ä—ã–µ **–ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–π –º–∞—Ä–∂–µ**
- –î–ª—è NGG6: API dlong = 0.33 ‚ÇΩ, –Ω–æ —Ä–µ–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞ = 7 667,72 ‚ÇΩ
- –î–ª—è PTH6: API dlong = 0.2834 ‚ÇΩ, –Ω–æ —Ä–µ–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞ = 33 860,23 ‚ÇΩ

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ–≤–∞—Ä—å `MARGIN_PER_LOT` –∫–∞–∫ **–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫**
- –ó–Ω–∞—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ Tinkoff
- API –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è fallback –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤

```python
# –ü–†–ê–í–ò–õ–¨–ù–û:
required_for_1_lot = margin_per_lot  # –¢–æ–ª—å–∫–æ –ì–û
max_lots = balance / margin_per_lot

# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
required_for_1_lot = margin_per_lot + lot_value  # ‚ùå
max_lots = balance / (margin_per_lot + lot_value)  # ‚ùå
```

### üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ

```python
result = {
    "current_price": 78.0,           # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
    "lot_size": 1,                    # –õ–æ—Ç–Ω–æ—Å—Ç—å
    "lot_value": 78.0,                # –°—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
    "margin_per_lot": 1574.5,         # –ì–û –∑–∞ –ª–æ—Ç (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
    "max_lots_available": 3,         # –ú–∞–∫—Å–∏–º—É–º –ª–æ—Ç–æ–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
    "margin_pct_of_balance": 31.49,   # –ì–û –≤ % –æ—Ç –±–∞–ª–∞–Ω—Å–∞
}
```

---

## 6. –û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ —Ä–∞—Å—á–µ—Ç–∞ –ì–û

```python
# –£—Ä–æ–≤–µ–Ω—å DEBUG –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:
logger.debug(f"{ticker}: Calculated margin via min_price_increment: {margin_per_lot:.2f} ‚ÇΩ")
logger.debug(f"{ticker}: Using fallback margin calculation: {margin_per_lot:.2f} ‚ÇΩ")
```

### –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞

```python
# –£—Ä–æ–≤–µ–Ω—å DEBUG –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞:
logger.debug(f"Skipping {ticker}: –ì–û {margin_per_lot:.2f} ‚ÇΩ > balance {balance:.2f} ‚ÇΩ")
logger.debug(f"Skipping {ticker}: margin {margin_per_lot:.2f} ‚ÇΩ > max {max_margin:.2f} ‚ÇΩ")
```

---

## 7. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–ª–æ–≤–∞—Ä—å MARGIN_PER_LOT** –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ Tinkoff –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
2. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å** –∏–∑ API –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
4. **–ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ª–æ—Ç–∞** –∫ –ì–û –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–ª–∞–Ω—Å–∞

---

## 8. –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `find_optimal_instruments.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
- `bot/margin_rates.py` - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ì–û –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
- `docs/MARGIN_DETERMINATION_ALGORITHM.md` - –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ì–û
