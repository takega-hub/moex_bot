# CSV Storage System

## Обзор

Система хранения данных переведена на CSV формат, аналогично криптоботу. Данные хранятся в папке `ml_data/`.

## Структура файлов

### 1. Кэш-файлы (основные данные)
Формат: `{TICKER}_{INTERVAL}_cache.csv`

Примеры:
- `VBH6_15_cache.csv` - кэш для VBH6 с интервалом 15 минут
- `SRH6_60_cache.csv` - кэш для SRH6 с интервалом 1 час

**Содержимое**: Все актуальные свечи для инструмента и интервала

### 2. Исторические файлы (архивы)
Формат: `{TICKER}_{INTERVAL}_{START_DATE}_{END_DATE}.csv`

Примеры:
- `VBH6_15_20260207_20260209.csv` - данные за период 07.02.2026 - 09.02.2026
- `SRH6_60_20260101_20260131.csv` - данные за январь 2026

**Содержимое**: Свечи за конкретный период (для архивирования)

### 3. Справочные файлы

#### `instruments.csv`
Информация об инструментах:
```csv
figi,ticker,name,instrument_type,updated_at
FUTVTBR03260,VBH6,VTBR-3.26 ВТБ,futures,2026-02-09 14:58:01
```

#### `trades.csv`
История сделок:
```csv
order_id,figi,direction,quantity,price,executed_at,status
12345,FUTVTBR03260,Buy,1,8581.0,2026-02-09 15:00:00,executed
```

## Формат данных свечей

```csv
timestamp,open,high,low,close,volume
2026-02-07 11:45:00,8581.00,8595.00,8580.00,8589.00,1098
2026-02-07 12:00:00,8589.00,8595.00,8585.00,8590.00,1205
```

**Колонки**:
- `timestamp` - время свечи (datetime)
- `open` - цена открытия
- `high` - максимальная цена
- `low` - минимальная цена
- `close` - цена закрытия
- `volume` - объем

## Нормализация интервалов

Интервалы преобразуются в числовой формат:
- `1min` → `1`
- `5min` → `5`
- `15min` → `15`
- `1hour` → `60`
- `4hour` → `240`
- `day` → `1440`

## Работа с данными

### Сохранение свечей
```python
from data.storage import DataStorage

storage = DataStorage()
storage.save_candles(figi="FUTVTBR03260", candles=candles_list, interval="15min")
```

### Чтение свечей
```python
df = storage.get_candles(
    figi="FUTVTBR03260",
    from_date=datetime(2026, 2, 1),
    to_date=datetime(2026, 2, 9),
    interval="15min",
    limit=100
)
```

### Получение последней свечи
```python
latest = storage.get_latest_candle(figi="FUTVTBR03260", interval="15min")
```

## Преимущества CSV формата

1. **Совместимость**: Та же структура, что в криптоботе
2. **Читаемость**: Легко просматривать в Excel/текстовых редакторах
3. **Простота**: Не требует базы данных
4. **Резервное копирование**: Просто копировать папку `ml_data/`
5. **ML обучение**: Удобно для загрузки данных в модели

## Миграция данных

> **Примечание**: Система изначально использует CSV формат. Если у вас были данные в другом формате, их нужно будет конвертировать вручную.

## Автоматическое управление

Система автоматически:
- Создает кэш-файлы при сохранении
- Объединяет новые данные с существующими
- Удаляет дубликаты по timestamp
- Создает исторические файлы для архивирования
- Восстанавливает кэш из исторических файлов, если кэш отсутствует
