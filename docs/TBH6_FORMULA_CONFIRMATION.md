# Подтверждение формулы расчета ГО для TBH6

## ✅ Формула работает правильно!

Скрипт `find_margin_formula.py` подтвердил, что формула расчета ГО работает корректно:

```
✅ point_value * price * dlong  = 882.75 ₽ | разница: 3.00 ₽ (0.34%)
✅ point_value * price * dshort = 882.75 ₽ | разница: 3.00 ₽ (0.34%)
```

**Сравнение с терминалом:**
- Терминал Tinkoff: **885.75 ₽**
- Формула: **882.75 ₽**
- Разница: **3.00 ₽ (0.34%)** ✅

---

## Формула расчета

```python
ГО = min_price_increment × current_price × dshort
ГО = 1.0 × 3531.0 × 0.25 = 882.75 ₽
```

**Где:**
- `min_price_increment` = 1.0 (стоимость пункта из API)
- `current_price` = 3531.0 ₽ (текущая цена)
- `dshort` = 0.25 (коэффициент из API)

---

## Почему в find_optimal_instruments.py использовался fallback?

### Проблема

В `find_optimal_instruments.py` скрипт рассчитал **423.72 ₽** (fallback 12%), а не **882.75 ₽** (формула).

### Возможные причины

1. **Функция `get_margin_per_lot_from_api_data` вернула None**
   - Возможно, `min_price_increment` не был передан правильно
   - Или `dlong`/`dshort` были None или 0
   - Или проверка `point_value > 0` не прошла

2. **Логика в `find_optimal_instruments.py`**
   - Код проверяет результат функции, но если она вернула None, переходит к fallback

### Решение

Теперь, когда TBH6 добавлен в словарь `MARGIN_PER_LOT`:
- Приоритет 1: Используется значение из словаря (885.75 ₽) ✅
- Формула работает для инструментов, которых нет в словаре ✅

---

## Приоритеты расчета ГО

### В `find_optimal_instruments.py`:

1. **Приоритет 1:** Словарь `MARGIN_PER_LOT` (если есть)
2. **Приоритет 2:** Формула через `min_price_increment` (если доступно)
3. **Приоритет 3:** Автоматический расчет из похожих инструментов
4. **Приоритет 4:** Fallback (12% от стоимости лота)

### В `get_margin_per_lot_from_api_data`:

1. **Приоритет 1:** Словарь `MARGIN_PER_LOT` (если есть)
2. **Приоритет 2:** Формула `point_value × price × dlong/dshort`

---

## Рекомендации

1. ✅ **Формула работает правильно** - можно использовать для новых инструментов
2. ✅ **TBH6 добавлен в словарь** - теперь используется точное значение из терминала
3. ⚠️ **Для новых инструментов** - сначала проверьте формулу через `find_margin_formula.py`
4. ⚠️ **Если формула не работает** - добавьте значение в словарь из терминала

---

## Пример использования формулы

```python
from bot.margin_rates import get_margin_per_lot_from_api_data

# Для TBH6 (теперь в словаре, но для примера):
margin = get_margin_per_lot_from_api_data(
    ticker="TBH6",
    current_price=3531.0,
    point_value=1.0,  # min_price_increment
    dlong=0.25,
    dshort=0.25,
    is_long=False
)
# Вернет: 885.75 ₽ (из словаря) или 882.75 ₽ (из формулы)
```

---

## Вывод

✅ **Формула `min_price_increment × price × dshort` работает правильно!**

Разница с терминалом всего 0.34%, что является нормальным отклонением из-за:
- Изменения цены между запросами
- Округлений
- Динамических изменений маржи на бирже

**Рекомендация:** Используйте формулу для новых инструментов, но для критических инструментов лучше добавить значение в словарь из терминала.
