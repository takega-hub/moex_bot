# Алгоритм определения гарантийного обеспечения (ГО) для инструментов

## Цель

Определить четкий порядок поиска и установки правильного значения гарантийного обеспечения для всех инструментов:
- Существующих (старых)
- Новых (только что добавленных)
- Вновь добавляемых в будущем

## Проблема

API Tinkoff возвращает значения `dlong`/`dshort`, которые **НЕ соответствуют реальной марже**:
- Для NGG6: API dlong = 0.33 руб, но реальная маржа = 7 667,72 ₽
- Для PTH6: API dlong = 0.2834 руб, но реальная маржа = 33 860,23 ₽
- Для SVH6: реальная маржа = 15 751,12 ₽ (лотность = 10)
- Для S1H6: реальная маржа = 1 574,5 ₽ (лотность = 1)

## Автоматический расчет из API (НОВОЕ!)

### Автоматическое определение стоимости пункта

Для новых инструментов бот пытается автоматически определить стоимость пункта на основе похожих инструментов:

**Принцип:**
1. Если для инструмента нет значения в словаре, ищется похожий инструмент с известной маржей
2. Из известной маржи похожего инструмента вычисляется стоимость пункта: `стоимость_пункта = ГО / (цена * dshort)`
3. Вычисленная стоимость пункта используется для расчета маржи нового инструмента

**Пример:**
- Для нового инструмента на серебро (например, S1H7) нет значения в словаре
- Бот находит похожий инструмент S1H6 с известной маржей 1574.5 ₽
- Вычисляет стоимость пункта из S1H6
- Использует её для расчета маржи S1H7

**Ограничения:**
- ⚠️ Работает только для инструментов с похожими характеристиками
- ⚠️ Требует наличия хотя бы одного похожего инструмента с известной маржей
- ⚠️ Рекомендуется проверка в терминале для критически важных инструментов

---

## Алгоритм определения ГО

### Шаг 1: Проверка словаря MARGIN_PER_LOT (ПРИОРИТЕТ 1)

**Действие:** Проверить наличие значения в `bot/margin_rates.py` → `MARGIN_PER_LOT`

**Критерий:** Если `MARGIN_PER_LOT[ticker] > 0`, использовать это значение

**Источник:** Терминал Tinkoff (вручную обновляется)

**Пример:**
```python
if "NGG6" in MARGIN_PER_LOT and MARGIN_PER_LOT["NGG6"] > 0:
    margin = MARGIN_PER_LOT["NGG6"]  # 7667.72 ₽
```

**Статус:** ✅ **ОСНОВНОЙ ИСТОЧНИК** - самый надежный

---

### Шаг 2: Автоматический расчет стоимости пункта из похожих инструментов (ПРИОРИТЕТ 2 - НОВОЕ!)

**Действие:** Если значения в словаре нет, попытаться автоматически вычислить стоимость пункта

**Процесс:**
1. Найти похожий инструмент с известной маржей (по префиксу тикера или базовому активу)
2. Вычислить стоимость пункта: `стоимость_пункта = известная_маржа / (цена * dshort/dlong)`
3. Использовать вычисленную стоимость пункта для расчета маржи нового инструмента

**Пример:**
```python
# Для нового инструмента S1H7 (нет в словаре)
# Находим похожий S1H6 с маржей 1574.5 ₽
known_margin = 1574.5
current_price = 78.0
dshort = 0.214  # Из API для S1H7
point_value = 1574.5 / (78.0 * 0.214) = 94.2  # Вычисленная стоимость пункта
margin = 94.2 * 78.0 * 0.214 = 1574.5  # Рассчитанная маржа
```

**Статус:** ✅ **АВТОМАТИЧЕСКИЙ** - работает для похожих инструментов

---

### Шаг 3: Расчет через стоимость пункта (ПРИОРИТЕТ 3)

**Действие:** Если значение в словаре отсутствует или = 0, попробовать расчет через формулу

**Формула:**
```
ГО = стоимость_пункта * текущая_цена * dlong/dshort
```

**Условия:**
1. Инструмент должен быть в словаре `POINT_VALUE` (стоимость пункта известна)
2. Должна быть известна текущая цена
3. Должны быть доступны `dlong`/`dshort` из API

**Пример для PTH6:**
```python
point_value = 77.19  # Из терминала
current_price = 2049.7  # Текущая цена
dshort = 0.214  # Из API
margin = point_value * current_price * dshort  # 77.19 * 2049.7 * 0.214 = 33860.23 ₽
```

**Проверка:** Сравнить результат с терминалом для валидации

**Статус:** ⚠️ **ТРЕБУЕТ ВАЛИДАЦИИ** - формула работает не для всех инструментов

---

### Шаг 4: Процент от стоимости позиции (ПРИОРИТЕТ 4 - FALLBACK)

**Действие:** Если предыдущие методы не сработали, использовать процентный коэффициент

**Формула:**
```
ГО = цена * количество_лотов * размер_лота * процент_маржи
```

**Источник коэффициентов:**
- Словарь `MARGIN_RATE_PCT` в `bot/margin_rates.py`
- По умолчанию: 12% (если инструмента нет в словаре)

**Пример:**
```python
margin_rate = MARGIN_RATE_PCT.get("TICKER", 0.12)  # 12% по умолчанию
position_value = price * quantity * lot_size
margin = position_value * margin_rate
```

**Статус:** ⚠️ **НЕТОЧНЫЙ** - используется только как последний резерв

---

## Процесс для нового инструмента (АВТОМАТИЗИРОВАН)

### Когда добавляется новый инструмент:

1. **Автоматический расчет при запуске:**
   - Бот вызывает `calculate_margins_for_instruments()` при старте
   - Для каждого активного инструмента:
     - Пробует получить цену из данных
     - Получает `dlong`/`dshort` из API
     - **НОВОЕ:** Пытается автоматически определить стоимость пункта из похожих инструментов
     - Рассчитывает маржу по приоритету:
       1. Словарь MARGIN_PER_LOT
       2. **Автоматический расчет из похожих инструментов** ⭐
       3. Формула через стоимость пункта
       4. Процент от стоимости
     - Сохраняет в `state.instrument_margins`

2. **Проверка результата:**
   - Если маржа из словаря → ✅ **ИСПОЛЬЗОВАТЬ** (проверено)
   - Если маржа рассчитана автоматически из похожих → ⚠️ **РЕКОМЕНДУЕТСЯ ПРОВЕРКА В ТЕРМИНАЛЕ**
   - Если маржа = 0 или очень маленькая (< 1 руб) → ❌ **ТРЕБУЕТ РУЧНОГО ОБНОВЛЕНИЯ**
   - Если маржа рассчитана через процент → ❌ **ТРЕБУЕТ ОБНОВЛЕНИЯ ИЗ ТЕРМИНАЛА**

3. **Ручное обновление (РЕКОМЕНДУЕТСЯ для критически важных инструментов):**
   ```
   ШАГ 1: Открыть терминал Tinkoff
   ШАГ 2: Найти инструмент по тикеру
   ШАГ 3: Открыть характеристики фьючерса
   ШАГ 4: Найти "Гарантийное обеспечение" (значение за 1 лот)
   ШАГ 5: Обновить значение в bot/margin_rates.py:
   ```
   ```python
   MARGIN_PER_LOT: Dict[str, float] = {
       "NEW_TICKER": 12345.67,  # Из терминала (гарантийное обеспечение за лот)
   }
   ```

4. **Добавление стоимости пункта (опционально, для точного расчета):**
   - Если известна стоимость пункта из терминала, добавить в `POINT_VALUE`:
   ```python
   POINT_VALUE: Dict[str, float] = {
       "NEW_TICKER": 77.19,  # Из терминала
   }
   ```

5. **Перезапуск бота:**
   - После обновления словаря перезапустить бот
   - Бот пересчитает маржу с новым значением
   - Значение отобразится в статусе админки

---

## Автоматическая проверка

### Скрипт `check_margins.py`

Запускается для проверки всех активных инструментов:

```bash
python check_margins.py
```

**Что делает:**
1. Получает `dlong`/`dshort` из API
2. Получает текущую цену
3. Сравнивает с значениями из словаря
4. Выявляет расхождения
5. Сохраняет результаты в `margin_check_results.json`

**Использование:**
- Регулярная проверка (раз в день/неделю)
- После добавления нового инструмента
- При подозрении на неверные значения

---

## Валидация значений

### Критерии правильности:

1. **Значение из терминала** (самый надежный):
   - ✅ Берется напрямую из терминала Tinkoff
   - ✅ Показывается как "Гарантийное обеспечение" за лот
   - ✅ Не требует дополнительной проверки

2. **Расчет через формулу** (требует проверки):
   - ⚠️ Сравнить результат с терминалом
   - ⚠️ Если расхождение > 10% → использовать значение из терминала
   - ✅ Если совпадает → можно использовать формулу

3. **Процентный расчет** (временный):
   - ❌ Использовать только как временную меру
   - ❌ Обязательно обновить из терминала

---

## Чек-лист для нового инструмента

- [ ] Инструмент добавлен в `active_instruments`
- [ ] Бот запущен и рассчитал маржу автоматически
- [ ] Проверено значение в терминале Tinkoff
- [ ] Обновлено значение в `MARGIN_PER_LOT` (если отличается)
- [ ] (Опционально) Добавлена стоимость пункта в `POINT_VALUE`
- [ ] Перезапущен бот для применения изменений
- [ ] Проверено отображение маржи в статусе админки
- [ ] Запущен `check_margins.py` для валидации

---

## Текущие значения (актуальные)

| Тикер | Маржа (₽/лот) | Источник | Лотность | Стоимость пункта |
|-------|---------------|----------|----------|------------------|
| NGG6  | 7 667,72      | Терминал | ?        | ?                |
| PTH6  | 33 860,23     | Терминал | 1        | 77,19            |
| SVH6  | 15 751,12     | Терминал | 10       | 771,94           |
| S1H6  | 1 574,5       | Терминал | 1        | 77,19            |
| NRG6  | ?             | TODO     | ?        | ?                |
| VBH6  | ?             | TODO     | ?        | ?                |
| SRH6  | ?             | TODO     | ?        | ?                |
| GLDRUBF | ?           | TODO     | ?        | ?                |

---

## Резюме алгоритма (ОБНОВЛЕНО)

```
НОВЫЙ ИНСТРУМЕНТ
    ↓
1. Автоматический расчет при запуске (через get_margin_for_position)
   Приоритет:
   a) Словарь MARGIN_PER_LOT
   b) ⭐ Автоматический расчет из похожих инструментов (НОВОЕ!)
   c) Формула через стоимость пункта
   d) Процент от стоимости
    ↓
2. Проверка результата:
   - Если из словаря → ✅ Использовать (проверено)
   - Если автоматически из похожих → ⚠️ Рекомендуется проверить в терминале
   - Если из формулы → ⚠️ Проверить в терминале
   - Если из процента → ❌ ОБЯЗАТЕЛЬНО обновить из терминала
    ↓
3. Ручное обновление из терминала (РЕКОМЕНДУЕТСЯ для критических инструментов)
    ↓
4. Добавление в MARGIN_PER_LOT (для повышения точности)
    ↓
5. Перезапуск бота
    ↓
6. Валидация через check_margins.py
    ↓
✅ ГО определено и используется
```

## Преимущества автоматического расчета

✅ **Для новых инструментов:**
- Не нужно сразу обновлять словарь вручную
- Бот автоматически найдет похожий инструмент и рассчитает маржу
- Работает "из коробки" для инструментов на тот же базовый актив

⚠️ **Ограничения:**
- Требует наличия хотя бы одного похожего инструмента с известной маржей
- Точность зависит от схожести инструментов
- Рекомендуется проверка в терминале для критически важных инструментов

✅ **Для существующих инструментов:**
- Если значение уже в словаре - используется оно (самый надежный способ)
- Автоматический расчет используется только как fallback

---

## Важные замечания

1. **API значения НЕВЕРНЫЕ** - не полагайтесь на `dlong`/`dshort` напрямую
2. **Терминал - источник истины** - всегда проверяйте в терминале
3. **Регулярная проверка** - значения маржи могут изменяться биржей
4. **Лотность важна** - учитывайте лотность при сравнении значений
5. **Стоимость пункта** - помогает в расчете, но не всегда доступна через API
